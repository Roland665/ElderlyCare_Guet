# 项目说明

#### 简介
基于可穿戴设备和智能远程家居控制系统为一站式养老解决方案

# 赛事规划

## IotDA 资源定义

### 产品属性定义



**所有产品的"服务ID"都是"default"**



#### 所有非直连产品共有属性

1. 属性名称：shortAddr
   - 数据类型：string
   - 长度：4
   - 描述：每个终端设备都是基于Zigbee协议保持通信，短地址是Zigbee协议的属性之一，是由两字节数据组成。在IotDA的属性中对两字节数据使用十六进制紧邻表示。如：2H4B，表示的设备短地址为 0x2H 0x4B。

#### 灯控

1. 属性名称：brightness
   - 数据类型：string
   - 长度：8
   - 描述：一个灯控上四盏LED的亮度：AABBCCDD，ABCD分别对应1-4号灯的亮度（十六进制）。假设一号灯为满亮度，其他是灭的，则属性内容为64000000

#### 窗帘

1. 属性名称：left
   - 数据类型：int
   - 取值范围：0~100
   - 描述：左窗帘的打开程度，0表示全关，100表示全开
2. 属性名称：right
   - 数据类型：int
   - 取值范围：0~100
   - 描述：右窗帘的打开程度，0表示全关，100表示全开
3. 属性名称：humidity
   - 数据类型：decimal
   - 取值范围：浮点数
   - 描述：窗帘上报的室内湿度数据，单位为%
4. 属性名称：temperature
   - 数据类型：decimal
   - 取值范围：浮点数
   - 描述：窗帘上报的室内温度数据，单位为%

#### 智能门锁

1. 属性名称：lock_state
   - 数据类型：string
   - 长度：2
   - 描述：门锁的开关状态：如果为01，则门锁已打开；如果为00，则门锁已锁上
2. 属性名称：recogniting
   - 数据类型：string
   - 长度：2
   - 描述：是否正在识别人脸：如果为01，则正在识别人脸；如果为00，则无人脸识别
3. 属性名称：master
   - 数据类型：string
   - 长度：2
   - 描述：由用户设置的主人名字，用于服务

### 设备信息定义

#### 智能网关

"device_id": "6A6B2327004B1200",

"secret": "c2baa9e2289d30085f541ac7da4bf30f"

Zigbee长地址：6A6B2327004B1200（有天线的那个）

#### 灯控1号(非直连设备)

"device_id": "A6542A27004B1200",

Zigbee长地址：A6542A27004B1200

#### 灯控2号(非直连设备)

"device_id": "04072C27004B1200",

Zigbee长地址：04072C27004B1200

#### 智能窗帘(非直连设备)

"device_id": "",

Zigbee长地址：

#### 智能门锁

"device_id"："1122334455667788"

"secret":"7884b5ebce1e3658c65daea3b0a8b574"

## 硬件任务

1. 老项目的完善优化（中控、灯控、窗帘、空调、温湿度）

2. 智能手环 (esp32s3)
   - wifi蓝牙双模 - lz

   - OLED (最好是LVGL) - yz

   - 心率、血氧、体温 - yz

   - 陀螺仪 - yz

   - 扬声器声音警报(写死的mp3) - lz

   - -------------------------------------------------------------------------

   - **插入新设备：智能药盒的温控**
   - GPS - yz
   - 配合后端接入GPT，播放GPT的对话语音 - lz
   - 防碰撞-测距模块（先按键触发）- yz
   - 麦克风 - lz

3. Guet-TAG -  yz
   - 蓝牙连手表
   - gps

4. 室内气体监控系统 - lz

- CO 探测器

- 蜂鸣器警报

- **如果做的是ESP32**，那就数据直连IOTDA；**如果用stm32**，就先通过Zigbee过中控，也可以挂ESP32模块上云

5. 暖通系统（待选）

- 仅用一块屏幕来显示空调状态即可
- Zigbee 连接中控

6. 加湿系统（待选）
   - 加湿器模块，用于配合湿度数据实现智能感知控制
   - Zigbee 连接中控

## 终端设备设计

### 中控x1

主打消息处理、路由

#### 硬件组成

ESP32-S3 合宙 8M PSRAM 板 x1

E18-MS1PA2-PCB x1

### 灯控x2

#### 硬件组成

STM32f103c8t6 x1

E18-MS1PA2-PCB x1

LED x 4

### 门锁x1

#### 硬件组成

树莓派4B x1 ：人脸识别

树莓派摄像头 x1：图像采集

ESP32S3 x1：与IOT云端交互

#### 人脸录入方案

1. 远程开启人脸录入模式
2. esp32通知树莓派启动录入人脸模式
3. 树莓派重新建立识别模型

#### 人脸识别方案

1. 本地开启人脸识别
2. esp32通知树莓派开始识别人脸
3. 树莓派根据已有模型识别人脸，持续10秒，若期间成功检测人脸，则直接退出
4. 串口返回人脸主人名称给esp32

#### esp -> pi 数据帧

**数据帧构成**

| 有效数据长度 | 有效数据 |
| ------------ | -------- |
| 1字节        | 不定     |

**有效数据**

0x00：关闭人脸识别

0x01：开启人脸识别（十秒后自动关闭，识别成功后自动关闭）

0x02xxxxxx：人脸录入，并附带人脸名称(0x02与字符串间无空格)

#### pi -> esp 数据帧

**数据帧构成**

| 有效数据长度 | 有效数据(有效数据第一位是命令码) |
| ------------ | -------------------------------- |
| 1字节        | 不定                             |

**有效数据**

0x00：识别失败

0x01 xx xx xx：识别成功，并附带人脸名称字符串

0x02: 成功训练人脸

0x03 XX: 训练进度百分比 XX%

### 空调x3（未完成）

#### 硬件组成

STM32f103c8t6芯片 x1

E18-MS1PA2-PCB x1

4.0寸触摸TFT *1

### 窗帘x1

#### 硬件组成

STM32f103c8t6芯片 x1

E18-MS1PA2-PCB x1

SG90舵机 x2

# 通信规范

### 应用端->IoTDA

在IotDA的API名称为：**下发设备消息**

注：所有十六进制的字母大小写皆可

#### 对中控

server：消息源来自服务器

control：消息目标为中控

saddr：目标终端的短地址

dcode：目标终端设备类型码

rdata：实际控制有效数据

控制命令示例：

```json
//控制短地址为1E FC的灯控 打开所有灯
{
  "server": {
    "control": {
      "saddr": "1E FC",
      "dcode": "01",
      "rdata": "00 00 64"
    }
  }
}

// 测试用，打开中控入网权限（持续2分钟）
{
  "server": {
    "network": {
      "dcode": "00",
      "rdata": "00"
    }
  }
}
```

#### 对智能门锁

server：消息源来自服务器

doorlock：消息目标为门锁

rdata：实际控制有效数据。00：关锁；01：开锁；02：开始录入人脸（并后接用户设置的人脸名称）

name：人脸名称（rdata非02时，此项可为空）

控制命令示例：

```json
// 开门
{
  "server": {
    "doorlock": {
      "rdata": "01"
    }
  }
}

// 开始录入人脸(设置人名为Roland)
{
  "server": {
    "doorlock": {
      "rdata": "02",
      "name": "Roland"
    }
  }
}
```

### 门锁->IoTDA

在IotDA的API名称为：**设备消息上报**

doorlock：消息源来自门锁

server：消息目标为服务器

command：命令码。00：陌生人启用了人脸识别(即人脸识别失败)；01：熟人(或主人)启用了人脸识别

rdata：有效数据。如果command为00，则此字段固定位ohter；如果command为01，则此字段为被识别人的**名称**（在用户端设置）

反馈消息示例：

```json
// 陌生人启用了人脸识别(即人脸识别失败)
{
  "doorlock": {
    "server": {
      "command": "00",
      "rdata": "other"
    }
  }
}

// Roland 启用了人脸识别(即人脸识别成功)
{
  "doorlock": {
    "server": {
      "command": "01",
      "rdata": "Roland"
    }
  }
}
```

### 声控->中控

#### 数据帧格式(hex格式)

| 帧头           | 短地址 | 命令码 = 设备类型码 | 有效数据长度 | 有效数据(具体内容在《有效数据内容》) |
| -------------- | ------ | ------------------- | ------------ | ------------------------------------ |
| 36 36 35       | AA AA  | XX                  | YY           | ZZ ZZ……                              |
| 3字节（"665"） | 2字节  | 1字节               | 1字节        | ≥0                                   |

### 中控->IoTDA

在IotDA的API名称为：**设备消息上报**

### 终端->中控

#### 数据帧格式(hex格式)

| 帧头     | 命令码 = 设备类型码 | 有效数据长度 | 有效数据 |
| -------- | ------------------- | ------------ | -------- |
| 06 06 05 | AA                  | YY           | ZZ ZZ……  |
| 3字节    | 1字节               | 1字节        | ≥0       |



#### 请求入网申请0x00

  **有效数据内容**

| 申请设备类型码 | 短地址 |
| :------------- | :----- |
| 1字节          | 2字节  |

  例：（**灯控**长地址为**B4 FD 65 25 00 4B 12 00**、短地址为<u>2D B8</u>）

发送灯控终端的信息：36 36 35 **B4 FD 65 25 00 4B 12 00** 00 03 **01** <u>2D B8</u>

#### 心跳消息0xFE

 **有效数据内容**

| 心跳设备类型码 | 心跳设备短地址 | 是否需要应答 | 状态数据                                         |
| -------------- | -------------- | ------------ | ------------------------------------------------ |
| 1字节          | 2字节          | 1字节        | 大小由具体设备决定（具体内容在《设备类型码表》） |

  例：（发出应答设备长地址**A6 54 2A 27 00 4B 12 00**，短地址CE 9A）

发送灯控终端的心跳（需要应答）：36 36 35 **A6 54 2A 27 00 4B 12 00** FE 0C 01 CE 9A 01 00 00 00 00 00 00 00 00

#### 应答消息0xFF

 **有效数据内容**

| 应答信息                                    |
| ------------------------------------------- |
| 2字节<br />控制成功应答['O' 'K'(0x4F 0x4B)] |

  例：（发出应答设备长地址70 E4 61 25 00 4B 12 00）

  设备应答ok：36 36 35 70 E4 61 25 00 4B 12 00 FF 02 4F 4B

### 中控->终端

#### 数据帧格式(hex格式)

| 帧头           | 命令码 = 设备类型码 | 有效数据长度 | 有效数据(具体内容在《有效数据内容》) |
| -------------- | ------------------- | ------------ | ------------------------------------ |
| 36 36 35       | XX                  | YY           | ZZ ZZ……                              |
| 3字节（"665"） | 1字节               | 1字节        | ≥0                                   |

#### 入网申请反馈0x00

  有效数据内容

| 应答信息                                    |
| ------------------------------------------- |
| 1字节<br />0-等待用户端处理；1-同意；2-拒绝 |


#### 设备应答命令0xFF

  有效数据内容

| 应答信息                                    |
| ------------------------------------------- |
| 2字节<br />控制成功应答['O' 'K'(0x4F 0x4B)] |


  设备应答ok：36 36 35 FF 02 4F 4B


### 设备类型码表

|   具体设备中文名   | 对应码十六进制 |                    心跳状态数据长度及内容                    |
| :----------------: | :------------: | :----------------------------------------------------------: |
|        电灯        |      0x01      | 8字节 [1~4号灯亮度百分比, 1~4号灯模式: 00表示普通模式、01表示呼吸灯模式] |
| 窗帘（携带温湿度） |      0x02      | 6字节[左右窗帘打开程度百分比，湿度整数部分，湿度小数部分，温度整数，温度小数] |



### 有效数据内容

#### 电灯控制命令

  **有效数据内容**

| 目标电灯号                                    | 控制命令码 |
| --------------------------------------------- | ---------- |
| 1字节（00表示对所有灯）（01~04表示对1~4号灯） | 1~2字节    |

  **控制命令码表**

| 控制命令码 | 具体操作                                                     |
| ---------- | ------------------------------------------------------------ |
| 00 xx      | 亮度操作，将亮度调至 xx% （关灯即 xx = 00 ）                 |
| 01         | 进入普通模式（即常亮），一般在呼吸灯模式下执行，灯的亮度会保持在呼吸灯的瞬时状态 |
| 02         | 进入呼吸灯模式（从亮度 40% 向上增量开始呼吸）                |

#### 门锁控制命令

**有效数据内容**

|         控制命令码          |
| :-------------------------: |
| 1字节（00: 关锁，01: 开锁） |

#### 窗帘控制命令

**有效数据内容**

| 左右窗帘选中                                                 | 打开程度百分比   |
| ------------------------------------------------------------ | ---------------- |
| 1字节（00表示对两个窗帘同步控制）（01表示对左窗帘，02表示对右窗帘） | 1字节(0x00~0x64) |

# 其他

## Zigbee终端通信框架移植需修改的位置

1. CTRL+F   "这里一定要修改为对应终端的设备类型码"
2. SendHBPack_Task 任务中 HBPack 数组大小算式第三位根据对应终端心跳状态数据长度修改，发送心跳包的send_customFrame函数传参也要修改对应的数据长度
3. Zigbee_Update_TerminalOnlineFlag 函数中 HBPack 数组大小算式第三位根据对应终端心跳状态数据长度修改，发送心跳包的send_customFrame函数传参也要修改对应的数据长度
3. 中控的 terminal_news_handle_task 函数内的switch需增加对新设备类型的心跳包处理

## 怪异问题

1. esp32串口设置为SERIAL_8E1，电脑串口助手在115200下通信不正常，换1.5/2停止位就正常，在921600和1停止位下也正常，但是在115200下和zigbee模块通信正常。。。
1. esp32 PubSubClient库的MQTT回调函数似乎是发生在核心1，而且看起来像是一个低优先级的任务挂着的，写一个优先级为3的任务然后死循环，程序都不跑了。如果是在回调函数里写死循环，低优先级的任务依旧正常运行
1. pio路径不能有中文，否则无法编译
